var ScriptPKP=function(j){var b=false,d=false,m=1,q=0,p=null,l=false,g=false,i=this,o=5,c=[];var k=false;this.init=function(){m=Math.floor(Math.random()*(999-2)+2);q=j.news_id;g=j.not_status_proc;$("input[name='title']").parent("td").append();if($("input[name='title']").parent("td").length){var r='&ensp;<input class="edit btn btn-mini" type="button" onClick="PKP.getList(false); return false;" style="width:160px;" value="'+j.btn_name+'"><div id="pkinopoisk_list" style="background:none repeat scroll 0 0 #FFFFCC;border:1px solid #9E9E9E;margin-right:10px;margin-top:7px;max-height:150px;overflow:auto;padding:5px;width:600px;display: none;"></div><div id="pkinopoisk_result" style="position:relative;background:none repeat scroll 0 0 #FFFFCC;border:1px solid #9E9E9E;margin-right:10px;margin-top:7px;padding:5px;width:600px;max-height:600px;overflow:auto;padding:5px;display:none;"></div><div id="pkinopoisk_status" style="background:none repeat scroll 0 0 #FFFFCC;border:1px solid #9E9E9E;margin-right:10px;margin-top:7px;padding:5px;width:600px;padding:5px;display:none;"></div>';$("input[name='title']").parent("td").append(r)}else{if($("input[name='title']").parent("div").length){var r='&ensp;<button class="btn btn-sm btn-black" type="button" onClick="PKP.getList(false); return false;">'+j.btn_name+'</button><div id="pkinopoisk_list" style="background:none repeat scroll 0 0 #FFFFCC;border:1px solid #9E9E9E;margin-right:10px;margin-top:7px;max-height:150px;overflow:auto;padding:5px;width:600px;display: none;"></div><div id="pkinopoisk_result" style="position:relative;background:none repeat scroll 0 0 #FFFFCC;border:1px solid #9E9E9E;margin-right:10px;margin-top:7px;padding:5px;width:600px;max-height:600px;overflow:auto;padding:5px;display:none;"></div><div id="pkinopoisk_status" style="background:none repeat scroll 0 0 #FFFFCC;border:1px solid #9E9E9E;margin-right:10px;margin-top:7px;padding:5px;width:600px;padding:5px;display:none;"></div>';$("input[name='title']").parent("div").append(r)}}if(j.keyEPS){$("input[name='title']").keypress(function(s){if(s.keyCode==13){i.getList("list");return false}})}if(typeof(create_editor)=="function"||typeof(tinyMCE)=="object"){l=true}};this.getList=function(s){var v=s?"list_all":"list";var u=$("input[name='title']").val();u=$.trim(u);var r="#pkinopoisk_list";if(u==""){a(r,'<span style="color: red;">Для поиска введите название фильма в заголовок статьи!</span>');return false}var t={id:v,title:u};h(t,r)};this.getUp=function(t){var s={id:t,title:"get_up",sact:"get_up"};var r="#pkinopoisk_result";h(s,r)};this.choosePoster=function(r){e(r,"poster_choose","#poster_choose","#poster_choose_list","poster_choose_list")};this.chooseKadr=function(r){e(r,"kadr_choose","#kadr_choose","#kadr_choose_list","kadr_choose_list")};function e(u,A,D,s,w){if($(D).attr("data-load")==1){$(s).toggle();if($(s).is(":visible")){y()}return false}var z={id:u,title:A,sact:A};h(z,"",v);$(D).attr("data-load","1");function v(){$(s+" li").click(function(){var F=$(this).attr("data-image_id");var E=$(this).attr("data-choosed");if(E==1){$(this).removeClass("choosed");$(D+' input[name="'+w+"["+F+']"]').remove();$(this).attr("data-choosed","0")}else{$(this).addClass("choosed");$(D).append('<input type="hidden" name="'+w+"["+F+']" value="'+F+'">');$(this).attr("data-choosed","1")}x()});y()}function x(){var E=0;var F=0;$(D).find('input[name^="'+w+'["]').each(function(){E++;F=$(this).val();$(D).find('[data-image_id="'+F+'"] .num').html(E)});$(D+" .num_all").html(E)}var B=0;function t(H){var E=$(H).attr("data-kp_id"),G=$(H).attr("data-type"),F=$(H).attr("data-page_num"),I=$(H).attr("data-link");if(B>=o){var K=setTimeout(function(){t(H)},500);c.push(K)}else{B++;var J={title:"load_image",sact:"load_image",kp_id:E,type:G,page_num:F,link:I};$.ajax({url:"/engine/ajax/pkinopoisk.php",type:"POST",data:J,dataType:"json",success:function(L){if(L.text){$(H).attr({src:L.text,"data-loaded":"1"})}B--;r()}})}}function y(){if($(D).find('img[data-loaded="0"]').length==0){return}$(D).find(".stop_load_image").show();$(D).find(".stop_load_image").click(function(){C()});$(D).find('img[data-loaded="0"]').each(function(){if($(this).attr("data-loaded")=="0"&&$(this).attr("data-link")){t(this)}})}function C(){$(D).find(".stop_load_image").hide();var E=c.length;for(var F=0;F<E;F++){var G=c.shift();clearTimeout(G)}return false}function r(){if($(D).find('img[data-loaded="0"]').length==0){C()}}}this.getUpMovei=function(u){var t={id:u,title:"getUpMovei"};var r=null;var s=null;$("#pkinopoisk_result :input").each(function(){r=$(this).attr("name");s=$(this).val();t[r]=s});h(t,"#pkinopoisk_result")};function h(t,s,r){if(b){return false}t.tio=m;t.news_id=q;$.ajax({url:"/engine/ajax/pkinopoisk.php",type:"POST",data:t,dataType:"json",success:function(v){if(!v){return false}if(v.container){s=v.container}if(v.is_get_up){p=v}var u=false;if(v.append){u=true}a(s,v.text,u);if(r){r()}},beforeSend:function(){b=true;n();if(typeof(ShowLoading)=="function"){ShowLoading("")}},complete:function(){b=false;if(typeof(HideLoading)=="function"){HideLoading("")}},error:function(u){b=false;if(typeof(HideLoading)=="function"){HideLoading("")}var v=$.trim(u.responseText);if(v){a(s,'<span style="color: red;">'+v+"</span>")}}})}function f(s,r){if((!l||r)&&s){s=s.replace(/(<br \/>|<br\/>|<br>)/gi,"\n")}return s}this.fill_form=function(s,C){var E=function(G,H,F){if(F=="e"){H=$(G).val()+H}else{if(F=="s"){H+=$(G).val()}}$(G).val(H)};var B=function(w,F){if(typeof($(w).tagsInput)=="function"){$(w).importTags(F)}else{if(typeof($(w).tokenfield)=="function"){$(w).tokenfield("setTokens",F)}}};var r=function(G,I,F){var H='[name="xfield['+G+']"][data-rel="links"]';if($('select[name="xfield['+G+']"]').length>0){I=I.toLowerCase();$('select[name="xfield['+G+']"] option').removeAttr("selected");$('select[name="xfield['+G+']"] option').each(function(){$(this).selected=false});$('select[name="xfield['+G+']"] option').each(function(){var w=$(this).html();w=w.toLowerCase();if(I==w){$(this).attr("selected","selected");$(this).selected=true;return false}});if($('select[name="xfield['+G+']"].uniform').length){$('select[name="xfield['+G+']"].uniform').uniform()}}else{if($(H).length>0&&(typeof($(H).tagsInput)=="function"||typeof($(H).tokenfield)=="function")){if(F=="e"){I=$(H).val()+","+I}else{if(F=="s"){I+=","+$(H).val()}}B(H,I)}else{E('[name="xfield['+G+']"],[id="xfield['+G+']"]',I,F)}}};var z={},v=null;if(s){z=s}else{z=p}if(z.fill_main){for(var D in z.fill_main){v=z.fill_main[D];v=f(v);if(v!=""){E("[name='"+D+"']",v,C)}}}if(z.fill_tags&&z.fill_tags.length>0){var y=z.fill_tags;if(C=="e"){y=$('[name="tags"]').val()+","+y}else{if(C=="s"){y+=","+$('[name="tags"]').val()}}if($('[name="tags"]').length>0&&(typeof($('[name="tags"]').tagsInput)=="function"||typeof($('[name="tags"]').tokenfield)=="function")){B('[name="tags"]',y)}else{E('[name="tags"]',y,C)}}if(z.fill_category&&z.fill_category.length>0){var A=$("[name='category[]'], [name='catlist[]']").val();A=$.isArray(A)?$.merge(A,z.fill_category):z.fill_category;var u=A;var t=u.length;A=[];for(var x=0;x<t;x++){if(u[x]>0){A.push(u[x])}}$("[name='category[]'], [name='catlist[]']").val(A);if($("[name='category[]'], [name='catlist[]']").hasClass("chzn-done")){$("[name='category[]'], [name='catlist[]']").trigger("liszt:updated")}}if(z.fill_xfield){for(var D in z.fill_xfield){v=z.fill_xfield[D];v=f(v);if(v!=""){r(D,v,C)}}}if(z.fill_person){for(var D in z.fill_person){v=z.fill_person[D];v=f(v,true);if(v!=""){E("#"+D,v,C)}}}if(typeof(create_editor)=="function"){create_editor()}if(typeof(CPM)=="object"&&typeof(CPM.add_cpm_all)=="function"&&z.cpm){CPM.add_cpm_all("movie",z.cpm)}return false};this.to_make_form=function(u,r){var t={},s=u.length;if(s==2&&p[u[0]]&&p[u[0]][u[1]]){t[u[0]]={};t[u[0]][u[1]]=p[u[0]][u[1]]}else{if(s==1&&u[0]=="all"){t=p}else{if(s==1&&p[u[0]]){t[u[0]]=p[u[0]]}}}i.fill_form(t,r);return false};function a(t,s,r){if(r){$(t).show().append(s)}else{$(t).show().html(s)}}function n(){if(g){return false}var u="#pkinopoisk_status";function t(){if(!b){r();return false}else{if(d){return false}}$.ajax({url:"/engine/ajax/pkinopoisk.php",type:"POST",data:"tio="+m+"&id=tio",global:false,dataType:"json",success:function(v){if(v.text=="finish"){r();return}a(u,v.text)},beforeSend:function(){d=true},complete:function(){d=false}})}function s(){if(b&&k===false){k=setInterval(function(){t()},750)}}function r(){$(u).hide();clearInterval(k);k=false}setTimeout(s,500)}};var PKP=new ScriptPKP(config_pkp);setTimeout(function(){if(typeof(jQuery)=="undefined"){var a=document.createElement("script");a.type="text/javascript";a.src="http://code.jquery.com/jquery-latest.min.js";document.getElementsByTagName("head")[0].appendChild(a);if(a.addEventListener){a.addEventListener("load",PKP.init,false)}else{if(a.attachEvent){a.attachEvent("onload",PKP.init)}}}else{PKP.init()}},250);